<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GasMonitor IoT</title>
    <base href="/" />
    <link rel="stylesheet" href="css/bootstrap/bootstrap.min.css" />
    <link rel="stylesheet" href="css/app.css" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>

<body>
    <div id="app">
        <div style="position:absolute; top:30vh; width:100%; text-align:center">
            <div class="spinner-border text-primary" role="status"></div>
            <p>Carregando...</p>
        </div>
    </div>

    <div id="blazor-error-ui">
        Ocorreu um erro.
        <a href="" class="reload">Recarregar</a>
        <a class="dismiss">游딏</a>
    </div>

    <script src="_framework/blazor.webassembly.js"></script>

    <script>
        let chartInstance = null;
        let chartTurnoInstance = null;
        let chartSemanaInstance = null;
        let chartPrecoInstance = null;

        // 1. DASHBOARD (LINHA TEMPO REAL)
        window.desenharGrafico = (labels, valores) => {
            const ctx = document.getElementById('graficoGas');
            if (!ctx) return;

            if (chartInstance) chartInstance.destroy();

            const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(37, 99, 235, 0.5)');
            gradient.addColorStop(1, 'rgba(37, 99, 235, 0.0)');

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'N칤vel (%)',
                        data: valores,
                        borderColor: '#2563eb',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { grid: { display: false } }, y: { min: 0, max: 100 } },
                    animation: false
                }
            });
        }

        // 2. RELAT칍RIOS (PIZZA, BARRAS E PRE칂O)
        window.desenharGraficosRelatorio = (stats) => {
            // Tratamento de Mai칰sculas/Min칰sculas do C#
            const dia = stats.consumoDiaKg || stats.ConsumoDiaKg || 0;
            const noite = stats.consumoNoiteKg || stats.ConsumoNoiteKg || 0;
            const diasDict = stats.consumoPorDiaSemana || stats.ConsumoPorDiaSemana || {};
            const listaPrecos = stats.historicoPrecos || stats.HistoricoPrecos || [];

            // A. Gr치fico Pizza
            const ctxTurno = document.getElementById('graficoTurno');
            if (ctxTurno) {
                if (chartTurnoInstance) chartTurnoInstance.destroy();
                chartTurnoInstance = new Chart(ctxTurno, {
                    type: 'doughnut',
                    data: {
                        labels: ['Dia', 'Noite'],
                        datasets: [{
                            data: [dia, noite],
                            backgroundColor: ['#f59e0b', '#1e293b'],
                            borderWidth: 0
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            // B. Gr치fico Barras
            const ctxSemana = document.getElementById('graficoSemana');
            if (ctxSemana) {
                if (chartSemanaInstance) chartSemanaInstance.destroy();
                chartSemanaInstance = new Chart(ctxSemana, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(diasDict),
                        datasets: [{
                            label: 'Consumo (Kg)',
                            data: Object.values(diasDict),
                            backgroundColor: '#3b82f6',
                            borderRadius: 4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            // C. Gr치fico de Hist칩rico de Pre칞os (O NOVO)
            const ctxPreco = document.getElementById('graficoPrecos');
            if (ctxPreco && listaPrecos.length > 0) {
                if (chartPrecoInstance) chartPrecoInstance.destroy();

                // Mapeia os dados para o formato do Chart.js
                const labelsPreco = listaPrecos.map(p => new Date(p.data || p.Data).toLocaleDateString());
                const dadosPreco = listaPrecos.map(p => p.valor || p.Valor);

                chartPrecoInstance = new Chart(ctxPreco, {
                    type: 'line',
                    data: {
                        labels: labelsPreco,
                        datasets: [{
                            label: 'Valor Pago (R$)',
                            data: dadosPreco,
                            borderColor: '#10b981', // Verde
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }
        }
    </script>
</body>
</html>