@page "/relatorios"
@using GasMonitor.App.Models
@inject HttpClient Http
@inject IJSRuntime JS

<div class="container-fluid p-4">
    <h2 class="fw-bold mb-4 text-dark">üìä Intelig√™ncia de Consumo</h2>

    <div class="card-moderno bg-white mb-4">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label small text-muted">In√≠cio</label>
                <input type="date" class="form-control" @bind="dataInicio" />
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted">Fim</label>
                <input type="date" class="form-control" @bind="dataFim" />
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100" @onclick="CarregarDados">Filtrar</button>
            </div>
            <div class="col-md-2">
                <button class="btn btn-outline-secondary w-100" @onclick="LimparFiltros">Limpar</button>
            </div>
        </div>
    </div>

    @if (stats == null)
    {
        <div class="alert alert-light text-center">Carregando dados...</div>
    }
    else
    {
        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="card-moderno text-center">
                    <small class="text-muted d-block">Dias Analisados</small>
                    <strong class="fs-4">@stats.DiasDeUso</strong>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card-moderno text-center">
                    <small class="text-muted d-block">M√©dia Di√°ria</small>
                    <strong class="fs-4 text-primary">@stats.MediaConsumoDiarioKg Kg</strong>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card-moderno text-center">
                    <small class="text-muted d-block">Turno Pico</small>
                    <strong class="fs-4">@stats.TurnoMaisConsumidor</strong>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="card-moderno h-100">
                    <h5 class="mb-3">Turno (Dia/Noite)</h5>
                    <div style="height: 250px;"><canvas id="graficoTurno"></canvas></div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card-moderno h-100">
                    <h5 class="mb-3">Consumo por Dia da Semana</h5>
                    <div style="height: 250px;"><canvas id="graficoSemana"></canvas></div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card-moderno">
                    <h5 class="mb-3">Hist√≥rico de Pre√ßos Pagos</h5>
                    @if (stats.HistoricoPrecos != null && stats.HistoricoPrecos.Count > 0)
                    {
                        <div style="height: 300px;"><canvas id="graficoPrecos"></canvas></div>
                    }
                    else
                    {
                        <div class="text-center py-5 text-muted bg-light rounded">
                            <p class="mb-0">Nenhum hist√≥rico de troca registrado neste per√≠odo.</p>
                            <small>Use o bot√£o "Recarregar" no Simulador (R) ou na Dashboard para gerar dados.</small>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>

@code {
    private EstatisticasResponse? stats;
    private DateTime? dataInicio = DateTime.Now.AddDays(-30);
    private DateTime? dataFim = DateTime.Now;
    private bool desenharGraficos = false;

    protected override async Task OnInitializedAsync() => await CarregarDados();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (desenharGraficos && stats != null)
        {
            desenharGraficos = false;
            await JS.InvokeVoidAsync("desenharGraficosRelatorio", stats);
        }
    }

    private async Task CarregarDados()
    {
        try
        {
            var query = new List<string>();
            if (dataInicio.HasValue) query.Add($"inicio={dataInicio.Value:yyyy-MM-dd}");
            if (dataFim.HasValue) query.Add($"fim={dataFim.Value:yyyy-MM-dd}");
            
            var url = "api/estatisticas" + (query.Any() ? "?" + string.Join("&", query) : "");
            
            stats = await Http.GetFromJsonAsync<EstatisticasResponse>(url);
            if (stats != null) desenharGraficos = true;
        }
        catch (Exception ex) { Console.WriteLine(ex.Message); }
    }

    private async Task LimparFiltros()
    {
        dataInicio = null;
        dataFim = null;
        await CarregarDados();
    }
}