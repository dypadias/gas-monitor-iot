<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de G치s IoT</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Estilos CSS (O Visual) */
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2c3e50; }
        
        /* Cart칫es de Estado */
        .status-cards { display: flex; gap: 20px; margin-bottom: 30px; justify-content: space-around; }
        .card { background: #ecf0f1; padding: 15px; border-radius: 8px; text-align: center; flex: 1; }
        .card h3 { margin: 0 0 10px 0; font-size: 14px; color: #7f8c8d; }
        .card .valor { font-size: 24px; font-weight: bold; color: #2c3e50; }
        
        /* Cores din칙micas para o status */
        .status-ok { color: #27ae60; }       /* Verde */
        .status-atencao { color: #e67e22; }  /* Laranja */
        .status-perigo { color: #c0392b; }   /* Vermelho */

        .canvas-container { position: relative; height: 40vh; width: 100%; }
        button { display: block; margin: 20px auto; padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #2980b9; }
    </style>
</head>
<body>

    <div class="container">
        <h1>游댠 Monitor de Botij칚o IoT</h1>

        <div class="status-cards">
            <div class="card">
                <h3>N칤vel Atual</h3>
                <div id="lblPorcentagem" class="valor">--%</div>
            </div>
            <div class="card">
                <h3>Peso Total</h3>
                <div id="lblPeso" class="valor">-- Kg</div>
            </div>
            <div class="card">
                <h3>Status</h3>
                <div id="lblStatus" class="valor">--</div>
            </div>
        </div>

        <div class="canvas-container">
            <canvas id="graficoGas"></canvas>
        </div>

        <button onclick="carregarDados()">游댃 Atualizar Agora</button>
        <p style="text-align: center; font-size: 12px; color: #999;">Atualiza automaticamente a cada 5s</p>
    </div>

    <script>
        // --- JAVASCRIPT (A L칩gica do Site) ---

        const API_URL = 'http://localhost:5092/api/medicoes'; // CONFIRA A PORTA DA SUA API!
        let meuGrafico = null;

        // Fun칞칚o principal que vai buscar os dados
        async function carregarDados() {
            try {
                // 1. Pedir dados  API
                const resposta = await fetch(API_URL);
                const dados = await resposta.json();

                if (dados.length === 0) return;

                // 2. Pegar o dado mais recente (o primeiro da lista)
                const ultimo = dados[0];

                // 3. Atualizar os n칰meros na tela
                document.getElementById('lblPeso').innerText = ultimo.pesoTotalKg + ' Kg';
                
                const lblPorc = document.getElementById('lblPorcentagem');
                lblPorc.innerText = ultimo.porcentagemGas + '%';
                
                // Muda a cor conforme a percentagem
                lblPorc.className = 'valor ' + (ultimo.porcentagemGas < 20 ? 'status-perigo' : 'status-ok');
                
                document.getElementById('lblStatus').innerText = ultimo.status;

                // 4. Atualizar o Gr치fico
                atualizarGrafico(dados);

            } catch (erro) {
                console.error('Erro ao buscar dados:', erro);
                document.getElementById('lblStatus').innerText = "Erro de Conex칚o";
            }
        }

        function atualizarGrafico(listaDados) {
            // Prepara os dados para o Chart.js (inverte para o mais antigo ficar na esquerda)
            // Pegamos apenas os 칰ltimos 20 registos para o gr치fico n칚o ficar gigante
            const ultimos20 = listaDados.slice(0, 20).reverse();

            const labels = ultimos20.map(item => new Date(item.dataHora).toLocaleTimeString());
            const valores = ultimos20.map(item => item.porcentagemGas);

            const ctx = document.getElementById('graficoGas').getContext('2d');

            // Se o gr치fico j치 existe, atualizamos os dados. Se n칚o, criamos um novo.
            if (meuGrafico) {
                meuGrafico.data.labels = labels;
                meuGrafico.data.datasets[0].data = valores;
                meuGrafico.update();
            } else {
                meuGrafico = new Chart(ctx, {
                    type: 'line', // Gr치fico de Linha
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '% de G치s',
                            data: valores,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.2)',
                            fill: true,
                            tension: 0.4 // Deixa a linha curva e suave
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, max: 100 }
                        }
                    }
                });
            }
        }

        // Inicia ao abrir a p치gina
        carregarDados();
        
        // Atualiza automaticamente a cada 5 segundos
        setInterval(carregarDados, 5000);

    </script>
</body>
</html>